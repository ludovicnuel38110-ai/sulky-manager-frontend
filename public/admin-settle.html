<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Sulky-Bet ‚Äì R√®glement course</title>
<link rel="stylesheet" href="style.css">

<style>

/* ================= BACKGROUND ================= */

body{
  background:
    linear-gradient(rgba(0,0,0,.55), rgba(0,0,0,.80)),
    url("images/bg.jpg");
  background-size:cover;
  background-position:center;
  background-attachment:fixed;
}


/* ================= CARD ================= */

.wrapper{
  max-width:650px;
  margin:80px auto;
  padding:25px;
}

.box{
  background:rgba(0,110,55,.55);
  backdrop-filter:blur(14px);
  border-radius:22px;
  padding:40px;
  border:1px solid rgba(0,255,136,.6);
  box-shadow:
    0 0 40px rgba(0,255,136,.25),
    inset 0 0 25px rgba(0,0,0,.45);
  text-align:center;
}


/* ================= TITRES ================= */

h2,h3{
  color:#00ff88;
  margin:18px 0;
}


/* ================= INPUTS ================= */

input, select{
  width:100%;
  padding:12px;
  margin-top:10px;
  border-radius:10px;
  border:none;
  background:rgba(0,0,0,.6);
  color:white;
  font-size:15px;
}


/* ================= BUTTON ================= */

button{
  width:100%;
  margin-top:20px;
  padding:14px;
  border:none;
  border-radius:12px;
  font-weight:bold;
  font-size:16px;
  background:linear-gradient(135deg,#00ff88,#00cc66);
  color:#001a0f;
  cursor:pointer;
  box-shadow:0 0 20px rgba(0,255,136,.7);
  transition:.2s;
}

button:hover{
  transform:translateY(-3px);
  box-shadow:0 0 35px #00ff88;
}

.back-btn{
  background:#001a0f;
  color:#00ff88;
  border:2px solid #00ff88;
}


/* ================= MESSAGE ================= */

#msg{
  margin-top:18px;
  font-weight:bold;
  color:#00ff88;
}

</style>
</head>



<body>

<div class="wrapper">
  <div class="box">

    <h2>‚öôÔ∏è R√®glement automatique de la course</h2>

    <!-- Race ID -->
    <input id="raceId" placeholder="Race ID (ex: 101)">

    <!-- üÜï Bouton charger -->
    <button id="btnLoad">üì• Charger les partants</button>


    <!-- ARRIVEE OFFICIELLE -->
    <h3>üèÅ Arriv√©e officielle</h3>

    <select id="first"></select>
    <select id="second"></select>
    <select id="third"></select>


    <!-- COTES -->
    <h3>üí∞ Cotes finales</h3>

    <input id="coteWin" type="number" step="0.01" placeholder="Simple gagnant">
    <input id="cotePlace" type="number" step="0.01" placeholder="Simple plac√©">
    <input id="coteCoupleWin" type="number" step="0.01" placeholder="Coupl√© gagnant">
    <input id="coteCouplePlace" type="number" step="0.01" placeholder="Coupl√© plac√©">
    <input id="coteTrio" type="number" step="0.01" placeholder="Trio">


    <button id="btnSettle">‚úÖ Valider et payer automatiquement</button>
    <button class="back-btn" onclick="location.href='dashboard.html'">‚¨Ö Retour dashboard</button>

    <p id="msg"></p>

  </div>
</div>



<script>

document.addEventListener("DOMContentLoaded", () => {

  const token = localStorage.getItem("token");
  if(!token) return location.href="login.html";

  const msg = document.getElementById("msg");

  const $ = id => document.getElementById(id);

  $("btnLoad").onclick = loadHorses;
  $("btnSettle").onclick = settle;


  /* =========================================
     CHARGER LES PARTANTS AUTO
  ========================================= */

  async function loadHorses(){

    const raceId = $("raceId").value;

    if(!raceId) return alert("Entre un Race ID");

    msg.innerText = "Chargement des chevaux...";

    try{

      const res = await fetch(
        "https://sulky-manager-backend.onrender.com/api/races/" + raceId
      );

      const race = await res.json();

      const horses = race.partants.map(p => p.cheval);

      fillSelect($("first"), horses);
      fillSelect($("second"), horses);
      fillSelect($("third"), horses);

      msg.innerText = "‚úÖ Chevaux charg√©s";

    }catch{
      msg.innerText = "‚ùå Impossible de charger la course";
    }
  }


  function fillSelect(select, horses){

    select.innerHTML = "";

    horses.forEach(h => {

      const opt = document.createElement("option");
      opt.value = h;
      opt.innerText = h;

      select.appendChild(opt);
    });
  }


  /* =========================================
     SETTLE
  ========================================= */

  async function settle(){

    msg.innerText = "Traitement en cours...";

    const body = {
      raceId: Number($("raceId").value),
      first: $("first").value,
      second: $("second").value,
      third: $("third").value,
      coteWin: Number($("coteWin").value || 1),
      cotePlace: Number($("cotePlace").value || 1),
      coteCoupleWin: Number($("coteCoupleWin").value || 1),
      coteCouplePlace: Number($("coteCouplePlace").value || 1),
      coteTrio: Number($("coteTrio").value || 1)
    };

    try{

      const res = await fetch(
        "https://sulky-manager-backend.onrender.com/api/admin/settle-results",
        {
          method:"POST",
          headers:{
            "Content-Type":"application/json",
            Authorization:"Bearer "+token
          },
          body:JSON.stringify(body)
        }
      );

      const data = await res.json();

      msg.innerText =
        `${data.message} | gagnants: ${data.winners}/${data.total}`;

    }catch{
      msg.innerText = "‚ùå Erreur serveur";
    }
  }

});

</script>

</body>
</html>
