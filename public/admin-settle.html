<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Sulky-Bet ‚Äì R√®glement course</title>
<link rel="stylesheet" href="style.css">

<style>

/* ================= BACKGROUND ================= */

body{
  background:
    linear-gradient(rgba(0,0,0,.65), rgba(0,0,0,.90)),
    url("images/bg.jpg");
  background-size:cover;
  background-position:center;
  background-attachment:fixed;
  font-family:Arial, Helvetica, sans-serif;
}


/* ================= CARD ================= */

.wrapper{
  max-width:760px;
  margin:70px auto;
  padding:25px;
}

.box{
  background:rgba(0,50,40,.85);
  backdrop-filter:blur(16px);
  border-radius:22px;
  padding:40px;
  border:1px solid #00d4aa;
  box-shadow:0 0 40px rgba(0,212,170,.25);
}


/* ================= TITRES ================= */

h2{
  text-align:center;
  color:#00e6c0;
  margin-bottom:25px;
}

h3{
  color:#00e6c0;
  margin-top:30px;
}


/* ================= INPUTS ================= */

input, select{
  width:100%;
  padding:12px;
  margin-top:10px;
  border-radius:10px;
  border:none;
  background:#0b2b26;
  color:white;
  font-size:15px;
}


/* ================= GRID GROUP ================= */

.grid-2{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:12px;
}

.grid-3{
  display:grid;
  grid-template-columns:1fr 1fr 1fr;
  gap:12px;
}


/* ================= BUTTON ================= */

button{
  width:100%;
  margin-top:18px;
  padding:14px;
  border:none;
  border-radius:12px;
  font-weight:bold;
  font-size:15px;
  background:linear-gradient(135deg,#00e6c0,#00bfa5);
  color:#00251f;
  cursor:pointer;
  transition:.2s;
}

button:hover{
  transform:translateY(-2px);
}

.back-btn{
  background:#111;
  color:#00e6c0;
  border:1px solid #00e6c0;
}


/* ================= MESSAGE ================= */

#msg{
  margin-top:20px;
  font-weight:bold;
  text-align:center;
  color:#00e6c0;
}

</style>
</head>



<body>

<div class="wrapper">
  <div class="box">

    <h2>‚öôÔ∏è R√®glement automatique de la course</h2>

    <!-- Race ID -->
    <input id="raceId" placeholder="Race ID (ex: 101)">
    <button id="btnLoad">üì• Charger les partants</button>


    <!-- ARRIVEE -->
    <h3>üèÅ Arriv√©e officielle</h3>
    <div class="grid-3">
      <select id="first"></select>
      <select id="second"></select>
      <select id="third"></select>
    </div>


    <!-- SIMPLE -->
    <h3>üí∞ Simple gagnant / plac√©</h3>

    <input id="coteWin" type="number" step="0.01" placeholder="Simple gagnant">

    <div class="grid-3">
      <input id="cotePlace1" type="number" step="0.01" placeholder="Plac√© 1er">
      <input id="cotePlace2" type="number" step="0.01" placeholder="Plac√© 2e">
      <input id="cotePlace3" type="number" step="0.01" placeholder="Plac√© 3e">
    </div>


    <!-- COUPLE -->
    <h3>üêé Coupl√© gagnant / plac√©</h3>

    <input id="coteCoupleWin" type="number" step="0.01" placeholder="Coupl√© gagnant">

    <div class="grid-3">
      <input id="coteCouple12" type="number" step="0.01" placeholder="Coupl√© 1-2">
      <input id="coteCouple13" type="number" step="0.01" placeholder="Coupl√© 1-3">
      <input id="coteCouple23" type="number" step="0.01" placeholder="Coupl√© 2-3">
    </div>


    <!-- TRIO -->
    <h3>üèÜ Trio</h3>
    <input id="coteTrio" type="number" step="0.01" placeholder="Trio">


    <button id="btnSettle">‚úÖ Valider et payer automatiquement</button>
    <button class="back-btn" onclick="location.href='dashboard.html'">‚¨Ö Retour dashboard</button>

    <p id="msg"></p>

  </div>
</div>



<script>

document.addEventListener("DOMContentLoaded", () => {

  const token = localStorage.getItem("token");
  if(!token) return location.href="login.html";

  const msg = document.getElementById("msg");
  const $ = id => document.getElementById(id);

  $("btnLoad").onclick = loadHorses;
  $("btnSettle").onclick = settle;


  /* ================= LOAD HORSES ================= */

  async function loadHorses(){

    const raceId = $("raceId").value;
    if(!raceId) return alert("Entre un Race ID");

    msg.innerText = "Chargement...";

    const res = await fetch(
      "https://sulky-manager-backend.onrender.com/api/races/" + raceId
    );

    const race = await res.json();
    const horses = race.partants.map(p=>p.cheval);

    ["first","second","third"].forEach(id=>{
      const select = $(id);
      select.innerHTML="";
      horses.forEach(h=>{
        const o=document.createElement("option");
        o.value=h;
        o.innerText=h;
        select.appendChild(o);
      });
    });

    msg.innerText="‚úÖ Chevaux charg√©s";
  }


  /* ================= SETTLE ================= */

  async function settle(){

    msg.innerText="Traitement...";

    const body = {

      raceId:Number($("raceId").value),
      first:$("first").value,
      second:$("second").value,
      third:$("third").value,

      coteWin:+$("coteWin").value||1,

      cotePlace1:+$("cotePlace1").value||1,
      cotePlace2:+$("cotePlace2").value||1,
      cotePlace3:+$("cotePlace3").value||1,

      coteCoupleWin:+$("coteCoupleWin").value||1,

      coteCouple12:+$("coteCouple12").value||1,
      coteCouple13:+$("coteCouple13").value||1,
      coteCouple23:+$("coteCouple23").value||1,

      coteTrio:+$("coteTrio").value||1
    };

    const res = await fetch(
      "https://sulky-manager-backend.onrender.com/api/admin/settle-results",
      {
        method:"POST",
        headers:{
          "Content-Type":"application/json",
          Authorization:"Bearer "+token
        },
        body:JSON.stringify(body)
      }
    );

    const data = await res.json();

    msg.innerText = `${data.message} | gagnants: ${data.winners}/${data.total}`;
  }

});
</script>

</body>
</html>
