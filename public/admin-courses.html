<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Sulky-Bet â€“ Admin Courses</title>
<link rel="stylesheet" href="style.css">

<style>
body{
  background:
    linear-gradient(rgba(0,0,0,.75),rgba(0,0,0,.9)),
    url("images/bg.jpg");
  background-size:cover;
  background-position:center;
  background-attachment:fixed;
  font-family:Segoe UI, sans-serif;
  color:white;
}

.admin-wrapper{
  max-width:1300px;
  margin:80px auto;
  padding:20px;
}

.admin-grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(360px,1fr));
  gap:30px;
}

.top-bar{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:40px;
}

.top-bar h2{
  color:#00ff88;
  text-shadow:0 0 12px #00ff88;
}

.admin-card{
  background:rgba(0,110,55,.6);
  backdrop-filter:blur(12px);
  border-radius:22px;
  padding:28px;
  border:1px solid rgba(0,255,136,.6);
  box-shadow:0 0 35px rgba(0,255,136,.25);
}

.admin-card h3{
  color:#00ff88;
  margin-bottom:15px;
}

input, textarea{
  width:100%;
  margin-top:10px;
  padding:12px;
  border-radius:10px;
  border:none;
  background:rgba(0,0,0,.6);
  color:#fff;
}

textarea{
  height:180px;
  font-family:monospace;
}

button{
  width:100%;
  margin-top:15px;
  padding:14px;
  border:none;
  border-radius:12px;
  background:linear-gradient(135deg,#00ff88,#00cc66);
  font-weight:bold;
  cursor:pointer;
}

.msg{
  margin-top:25px;
  text-align:center;
  font-weight:bold;
  color:#00ff88;
  font-size:18px;
}
</style>
</head>

<body>

<div class="admin-wrapper">

  <div class="top-bar">
    <h2>ğŸ› ï¸ Gestion des courses</h2>
    <button onclick="location.href='dashboard.html'">â¬… Retour dashboard</button>
  </div>

  <div class="admin-grid">

    <!-- ================= REUNION ================= -->
    <div class="admin-card">
      <h3>ğŸŸï¸ RÃ©union</h3>

      <input id="rName" placeholder="R1 â€“ VINCENNES">
      <input id="rDate" type="date">
      <button id="btnReunion">CrÃ©er la rÃ©union</button>

      <input id="delReunionId" placeholder="ID Ã  supprimer">
      <button id="btnDeleteReunion">ğŸ—‘ Supprimer rÃ©union</button>
    </div>


    <!-- ================= COURSE ================= -->
    <div class="admin-card">
      <h3>ğŸ‡ Course</h3>

      <input id="cReunion" placeholder="Reunion ID">
      <input id="cId" placeholder="ID course (101)">
      <input id="cLabel" placeholder="C1 â€“ Prix test">

      <label style="margin-top:10px;">Date</label>
      <input id="cDate" type="date">

      <label>Heure dÃ©part</label>
      <input id="cTime" type="time">

      <button id="btnCourse">Ajouter la course</button>
      <button id="btnDeleteCourse">ğŸ—‘ Supprimer course</button>
    </div>


    <!-- ================= RUNNERS ================= -->
    <div class="admin-card">
      <h3>ğŸ Chevaux</h3>

      <input id="pReunion" placeholder="Reunion ID">
      <input id="pRace" placeholder="Race ID">
      <input id="pCheval" placeholder="Nom du cheval">
      <input id="pDriver" placeholder="Driver">
      <input id="pProp" placeholder="PropriÃ©taire">
      <input id="pMusique" placeholder="Musique">
      <input id="pCote" placeholder="Cote">

      <button id="btnRunner">Ajouter le partant</button>

      <h3 style="margin-top:25px;">âš¡ Import automatique (CSV ; )</h3>

      <!-- âœ… FORMAT CORRIGÃ‰ -->
      <textarea id="bulkInput"
placeholder="numero;cheval;driver;proprietaire;musique;cote"></textarea>

      <button id="btnBulk">Importer tous les chevaux</button>
    </div>

  </div>

  <p id="msg" class="msg"></p>
</div>



<script>

/* ================= INIT DIRECT ================= */

init();

function init(){

  const token = localStorage.getItem("token");
  if(!token) location.href="login.html";

  const API = "https://sulky-manager-backend.onrender.com/api/admin";
  const msg = document.getElementById("msg");

  const $ = id => document.getElementById(id);

  async function post(url, body){
    const res = await fetch(API+url,{
      method:"POST",
      headers:{
        "Content-Type":"application/json",
        "Authorization":"Bearer "+token
      },
      body:JSON.stringify(body)
    });
    return res.json();
  }


  /* ================= EVENTS ================= */

  $("btnReunion").onclick = createReunion;
  $("btnCourse").onclick = addCourse;
  $("btnRunner").onclick = addRunner;
  $("btnBulk").onclick = importBulk;
  $("btnDeleteReunion").onclick = deleteReunion;
  $("btnDeleteCourse").onclick = deleteCourse;


  /* ================= CREATE REUNION ================= */

  async function createReunion(){
    const res = await post("/create-reunion",{
      reunion:$("rName").value,
      date:$("rDate").value
    });

    msg.innerText = res.message + " | ID: " + res.id;
  }


  /* ================= CREATE COURSE ================= */

  async function addCourse(){

    const date = $("cDate").value;
    const time = $("cTime").value || "00:00";

    const iso = date + "T" + time;

    const res = await post("/add-course",{
      reunionId:$("cReunion").value,
      id:Number($("cId").value),
      label:$("cLabel").value,
      date: iso
    });

    msg.innerText = res.message + " (" + iso + ")";
  }


  /* ================= RUNNER ================= */

  async function addRunner(){
    const res = await post("/add-runner",{
      reunionId:$("pReunion").value,
      raceId:Number($("pRace").value),
      cheval:$("pCheval").value,
      driver:$("pDriver").value,
      proprietaire:$("pProp").value,
      musique:$("pMusique").value,
      cote:Number($("pCote").value)
    });

    msg.innerText = res.message;
  }


  /* ================= BULK CSV FIX ================= */
  /* accepte : numero;cheval;driver;proprietaire;musique;cote */

  async function importBulk(){

    const reunionId = $("pReunion").value;
    const raceId = Number($("pRace").value);

    const lines = $("bulkInput").value
      .split("\n")
      .map(l => l.trim())
      .filter(Boolean);

    let created = 0;

    for(const line of lines){

      const cols = line.split(";").map(v => v.trim());

      if(cols.length !== 6) continue;

      const [numero, cheval, driver, proprietaire, musique, cote] = cols;

      await post("/add-runner",{
        reunionId,
        raceId,
        cheval,
        driver,
        proprietaire,
        musique,
        cote:Number(cote)
      });

      created++;
    }

    msg.innerText = created + " chevaux importÃ©s âœ…";
  }


  /* ================= DELETE ================= */

  async function deleteReunion(){
    const id = $("delReunionId").value;

    const res = await fetch(API+"/delete-reunion/"+id,{
      method:"DELETE",
      headers:{ Authorization:"Bearer "+token }
    }).then(r=>r.json());

    msg.innerText = res.message;
  }

  async function deleteCourse(){
    const res = await fetch(API+"/delete-course",{
      method:"DELETE",
      headers:{
        "Content-Type":"application/json",
        "Authorization":"Bearer "+token
      },
      body:JSON.stringify({
        reunionId:$("cReunion").value,
        raceId:Number($("cId").value)
      })
    }).then(r=>r.json());

    msg.innerText = res.message;
  }

}

</script>

</body>
</html>
