<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Sulky-Bet ‚Äì Course</title>
<link rel="stylesheet" href="style.css">
</head>

<body>

<header class="main-header">
  <div class="header-content">
    <div class="header-text">
      <h1 id="raceTitle">Course</h1>
      <p id="raceDate"></p>
    </div>

    <div>
      <span id="balanceBox">üí∞ 0 ‚Ç¨</span>
      <a href="meeting.html"><button>‚¨Ö Retour</button></a>
    </div>
  </div>
</header>

<div class="section">

  <table id="partantsTable" class="pmu-table">
    <thead>
      <tr>
        <th>#</th>
        <th>Cheval</th>
        <th>Driver</th>
        <th>Propri√©taire</th>
        <th>Musique</th>
        <th>Cote</th>
        <th>‚úî</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div class="bet-slip">
    <h3>Mon pari</h3>

    <div id="selectedList">Aucun cheval s√©lectionn√©</div>

    <select id="betType">
      <option value="simple_win">Simple gagnant</option>
      <option value="simple_place">Simple plac√©</option>
      <option value="couple">Coupl√©</option>
      <option value="trio">Trio</option>
    </select>

    <input id="stakeInput" type="number" placeholder="Mise ‚Ç¨">

    <button onclick="confirmBet()">Parier</button>
  </div>

</div>



<script>

/* ================= INIT DIRECT ================= */

init();

async function init(){

  const token = localStorage.getItem("token");
  if(!token) return location.href="login.html";

  const raceId = new URLSearchParams(location.search).get("id");
  if(!raceId) return location.href="races.html";

  await loadBalance(token);
  await loadRace(raceId);
}


/* ================= BALANCE ================= */

async function loadBalance(token){
  try{
    const r = await fetch(
      "https://sulky-manager-backend.onrender.com/api/users/me",
      { headers:{ Authorization:"Bearer "+token }}
    );
    const u = await r.json();
    document.getElementById("balanceBox").innerText="üí∞ "+u.balance+" ‚Ç¨";
  }catch{}
}


/* ================= LOAD COURSE ================= */

let selectedHorses=[];

async function loadRace(id){

  const r = await fetch(
    "https://sulky-manager-backend.onrender.com/api/races/"+id
  );

  const race = await r.json();

  raceTitle.innerText = race.label;
  raceDate.innerText  = race.date;

  const tbody = document.querySelector("#partantsTable tbody");

  race.partants.forEach((p,i)=>{

    const tr=document.createElement("tr");

    tr.innerHTML=`
      <td>${i+1}</td>
      <td>${p.cheval}</td>
      <td>${p.driver}</td>
      <td>${p.proprietaire}</td>
      <td>${p.musique}</td>
      <td>${p.cote}</td>
      <td>‚¨ú</td>
    `;

    tr.onclick=()=>toggleHorse(p,tr);

    tbody.appendChild(tr);
  });
}


/* ================= SELECTION ================= */

function requiredCount(t){
  return t==="trio"?3:t==="couple"?2:1;
}

function toggleHorse(h,row){

  const max = requiredCount(betType.value);

  const idx = selectedHorses.findIndex(x=>x.cheval===h.cheval);

  if(idx>=0){
    selectedHorses.splice(idx,1);
    row.lastElementChild.innerText="‚¨ú";
  }
  else{
    if(selectedHorses.length>=max) return;
    selectedHorses.push(h);
    row.lastElementChild.innerText="‚úÖ";
  }

  selectedList.innerHTML =
    selectedHorses.map(x=>x.cheval).join("<br>") ||
    "Aucun cheval s√©lectionn√©";
}


/* ================= BET ================= */

async function confirmBet(){

  const need = requiredCount(betType.value);

  if(selectedHorses.length!==need)
    return alert("Mauvais nombre de chevaux");

  const token = localStorage.getItem("token");

  await fetch(
    "https://sulky-manager-backend.onrender.com/api/bets",
    {
      method:"POST",
      headers:{
        "Content-Type":"application/json",
        Authorization:"Bearer "+token
      },
      body:JSON.stringify({
        raceId:+new URLSearchParams(location.search).get("id"),
        chevaux:selectedHorses,
        type:betType.value,
        montant:+stakeInput.value
      })
    }
  );

  location.reload();
}

</script>

</body>
</html>
