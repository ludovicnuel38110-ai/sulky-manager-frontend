<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Sulky-Bet ‚Äì Partants</title>
  <link rel="stylesheet" href="style.css">

  <style>
  /* ===== Layout 2 colonnes ===== */

  .race-layout{
    display:flex;
    gap:30px;
    align-items:flex-start;
  }

  .race-table{
    flex:3;
  }

  .bet-slip{
    flex:1;
    background:#021;
    padding:20px;
    border-radius:15px;
    border:2px solid #00ff88;
    position:sticky;
    top:20px;
    backdrop-filter:blur(8px);
  }

  .bet-slip h3{
    margin-top:0;
    color:#00ff88;
  }

  .bet-slip select,
  .bet-slip input{
    width:100%;
    padding:10px;
    margin-top:10px;
    border-radius:8px;
  }

  .bet-slip button{
    width:100%;
    margin-top:15px;
  }

  /* ===== s√©lection chevaux ===== */

  .pmu-table tbody tr{
    cursor:pointer;
    transition:0.15s;
  }

  .pmu-table tbody tr:hover{
    background:#003a2b;
  }

  .selected-row{
    background:#005a3f !important;
  }

  #balanceBox{
    font-weight:bold;
    color:#00ff88;
    margin-right:15px;
  }
  </style>
</head>

<body>

<header class="main-header">
  <div class="header-content">
    <div class="header-text">
      <h1 id="raceTitle">Course</h1>
      <p id="raceDate"></p>
    </div>

    <div class="header-actions">
      <span id="balanceBox">üí∞ 0 ‚Ç¨</span>
      <a href="meeting.html">
        <button>‚¨Ö Retour courses</button>
      </a>
    </div>
  </div>
</header>


<div class="section">
  <h2>üèá Partants</h2>

  <div class="race-layout">

    <!-- TABLE -->
    <div class="race-table">
      <table id="partantsTable" class="pmu-table">
        <thead>
          <tr>
            <th>#</th>
            <th>Cheval</th>
            <th>Driver</th>
            <th>Propri√©taire</th>
            <th>Musique</th>
            <th>Cote</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- BET SLIP -->
    <div class="bet-slip">

      <h3>üßæ Mon pari</h3>

      <div id="selectedList">Aucun cheval s√©lectionn√©</div>

      <select id="betType">
        <option value="simple_win">Simple gagnant</option>
        <option value="simple_place">Simple plac√©</option>
        <option value="couple">Coupl√©</option>
        <option value="trio">Trio</option>
      </select>

      <input id="stakeInput" type="number" placeholder="Mise ‚Ç¨">

      <button class="bet-btn" onclick="confirmBet()">
        Parier
      </button>

    </div>

  </div>
</div>


<script>
/* =========================
   üîπ Auth & solde
========================= */

const token = localStorage.getItem("token");
if (!token) window.location.href = "login.html";

const balance = localStorage.getItem("balance") || 0;
document.getElementById("balanceBox").innerText = "üí∞ " + balance + " ‚Ç¨";


/* =========================
   üîπ Params
========================= */

const params = new URLSearchParams(window.location.search);
const raceId = params.get("id");

if (!raceId) window.location.href = "races.html";


/* =========================
   üîπ Variables globales
========================= */

let selectedHorses = [];


/* =========================
   üîπ Charger course
========================= */

fetch("https://sulky-manager-backend.onrender.com/api/courses/" + raceId)
  .then(res => res.json())
  .then(race => {

    document.getElementById("raceTitle").innerText = race.label;
    document.getElementById("raceDate").innerText = race.date || "";

    const tbody = document.querySelector("#partantsTable tbody");

    race.partants.forEach((p, index) => {

      const tr = document.createElement("tr");

      tr.innerHTML = `
        <td>${index+1}</td>
        <td>${p.cheval}</td>
        <td>${p.driver}</td>
        <td>${p.proprietaire}</td>
        <td>${p.musique}</td>
        <td>${p.cote}</td>
      `;

      tr.onclick = () => toggleHorse(p, tr);

      tbody.appendChild(tr);
    });

  });


/* =========================
   üîπ S√©lection chevaux
========================= */

function toggleHorse(horse, row){

  const index = selectedHorses.findIndex(h => h.cheval === horse.cheval);

  if(index >= 0){
    selectedHorses.splice(index,1);
    row.classList.remove("selected-row");
  } else {
    selectedHorses.push(horse);
    row.classList.add("selected-row");
  }

  updateSlip();
}

function updateSlip(){

  const box = document.getElementById("selectedList");

  if(selectedHorses.length === 0){
    box.innerText = "Aucun cheval s√©lectionn√©";
    return;
  }

  box.innerHTML = selectedHorses
    .map(h => "‚Ä¢ " + h.cheval + " ("+h.cote+")")
    .join("<br>");
}


/* =========================
   üîπ Confirmer pari
========================= */

function confirmBet(){

  if(selectedHorses.length === 0){
    alert("S√©lectionne au moins un cheval");
    return;
  }

  const stake = Number(document.getElementById("stakeInput").value);
  const type = document.getElementById("betType").value;

  if(!stake || stake <= 0){
    alert("Mise invalide");
    return;
  }

  fetch("https://sulky-manager-backend.onrender.com/api/bets", {
    method:"POST",
    headers:{
      "Content-Type":"application/json",
      "Authorization":"Bearer " + token
    },
    body: JSON.stringify({
      raceId:Number(raceId),
      chevaux:selectedHorses,
      type,
      montant:stake
    })
  })
  .then(r=>r.json())
  .then(data=>{
    alert("‚úÖ Pari enregistr√© !");

    localStorage.setItem("balance", data.balance);
    location.reload();
  })
  .catch(()=>alert("Erreur pari"));
}
</script>

</body>
</html>
