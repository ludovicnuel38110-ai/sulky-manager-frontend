<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Sulky-Bet ‚Äì Course</title>
<link rel="stylesheet" href="style.css">

<style>
/* ===== LAYOUT COURSE ===== */

.section{
  max-width:1300px;
  margin:auto;
}

.race-layout{
  display:flex;
  gap:30px;
  align-items:flex-start;
}

.race-table{
  flex:3;
}

.bet-slip{
  flex:1;
  background:#021;
  padding:20px;
  border-radius:15px;
  border:2px solid #00ff88;
  position:sticky;
  top:20px;
  height:fit-content;
}

/* Countdown style */
#countdownBox{
  display:block;
  margin-top:6px;
  font-weight:bold;
  color:#00ff88;
}

/* Mobile */
@media(max-width:900px){
  .race-layout{
    flex-direction:column;
  }
}
</style>

</head>

<body>

<header class="main-header">
  <div class="header-content">

    <div class="header-text">
      <h1 id="raceTitle">Course</h1>
      <p id="raceDate"></p>
    </div>

    <!-- üí∞ SOLDE + ‚è≥ COUNTDOWN -->
    <div>
      <span id="balanceBox">üí∞ 0 ‚Ç¨</span><br>
      <span id="countdownBox">‚è≥ --:--</span><br>
      <a href="meeting.html"><button>‚¨Ö Retour</button></a>
    </div>

  </div>
</header>


<div class="section">

  <div class="race-layout">

    <!-- ================= TABLE ================= -->
    <div class="race-table">

      <table id="partantsTable" class="pmu-table">
        <thead>
          <tr>
            <th>#</th>
            <th>Cheval</th>
            <th>Driver</th>
            <th>Propri√©taire</th>
            <th>Musique</th>
            <th>Cote</th>
            <th>‚úî</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

    </div>


    <!-- ================= BET SLIP ================= -->
    <div class="bet-slip">

      <h3>üßæ Mon pari</h3>

      <div id="selectedList">Aucun cheval s√©lectionn√©</div>

      <select id="betType">
        <option value="simple_win">Simple gagnant</option>
        <option value="simple_place">Simple plac√©</option>
        <option value="couple_win">Coupl√© gagnant</option>
        <option value="couple_place">Coupl√© plac√©</option>
        <option value="trio">Trio</option>
      </select>

      <input id="stakeInput" type="number" placeholder="Mise ‚Ç¨">

      <button id="betBtn" onclick="confirmBet()">Parier</button>

    </div>

  </div>

</div>



<script>

/* =================================================
   INIT
================================================= */

init();

async function init(){

  const token = localStorage.getItem("token");
  if(!token) return location.href="login.html";

  const raceId = new URLSearchParams(location.search).get("id");
  if(!raceId) return location.href="races.html";

  await loadBalance(token);
  await loadRace(raceId);
}


/* =================================================
   BALANCE
================================================= */

async function loadBalance(token){
  try{
    const r = await fetch(
      "https://sulky-manager-backend.onrender.com/api/users/me",
      { headers:{ Authorization:"Bearer "+token }}
    );

    const u = await r.json();

    balanceBox.innerText = "üí∞ " + u.balance + " ‚Ç¨";
  }
  catch{}
}


/* =================================================
   COUNTDOWN + LOCK PARIS
================================================= */

function startCountdown(dateStr){

  const raceTime = new Date(dateStr).getTime();
  const box = document.getElementById("countdownBox");
  const btn = document.getElementById("betBtn");

  setInterval(()=>{

    const now = Date.now();
    const diff = raceTime - now;

    /* Course partie */
    if(diff <= 0){
      box.innerText = "üî¥ Course partie";
      btn.disabled = true;
      btn.style.opacity = 0.5;
      return;
    }

    const minutesLeft = diff / 60000;

    /* Fermeture 30min */
    if(minutesLeft <= 30){
      box.innerText = "üî¥ Paris ferm√©s";
      btn.disabled = true;
      btn.style.opacity = 0.5;
      return;
    }

    /* Countdown */
    const m = Math.floor(diff/60000);
    const s = Math.floor((diff%60000)/1000);

    box.innerText = "üïí D√©part dans : " + m + "m " + s + "s";

  },1000);
}


/* =================================================
   LOAD COURSE
================================================= */

let selectedHorses=[];

async function loadRace(id){

  const r = await fetch(
    "https://sulky-manager-backend.onrender.com/api/races/"+id
  );

  const race = await r.json();

  raceTitle.innerText = race.label;
  raceDate.innerText  = race.date;

  /* üî• d√©marre l'horloge */
  startCountdown(race.date);

  const tbody = document.querySelector("#partantsTable tbody");
  tbody.innerHTML = "";

  race.partants.forEach((p,i)=>{

    const tr=document.createElement("tr");

    tr.innerHTML=`
      <td>${i+1}</td>
      <td>${p.cheval}</td>
      <td>${p.driver}</td>
      <td>${p.proprietaire}</td>
      <td>${p.musique}</td>
      <td>${p.cote}</td>
      <td>‚¨ú</td>
    `;

    tr.onclick=()=>toggleHorse(p,tr);

    tbody.appendChild(tr);
  });
}


/* =================================================
   SELECTION
================================================= */

function requiredCount(t){

  if(t === "trio")
    return 3;

  if(t === "couple_win" || t === "couple_place")
    return 2;

  return 1;
}


function toggleHorse(h,row){

  const btn = document.getElementById("betBtn");
  if(btn.disabled) return; // üî¥ bloqu√© si paris ferm√©s

  const max = requiredCount(betType.value);

  const idx = selectedHorses.findIndex(x=>x.cheval===h.cheval);

  if(idx>=0){
    selectedHorses.splice(idx,1);
    row.lastElementChild.innerText="‚¨ú";
  }
  else{
    if(selectedHorses.length>=max) return;
    selectedHorses.push(h);
    row.lastElementChild.innerText="‚úÖ";
  }

  selectedList.innerHTML =
    selectedHorses.map(x=>x.cheval).join("<br>") ||
    "Aucun cheval s√©lectionn√©";
}


/* =================================================
   BET
================================================= */

async function confirmBet(){

  if(betBtn.disabled) return;

  const need = requiredCount(betType.value);

  if(selectedHorses.length!==need)
    return alert("Mauvais nombre de chevaux");

  const token = localStorage.getItem("token");

  await fetch(
    "https://sulky-manager-backend.onrender.com/api/bets",
    {
      method:"POST",
      headers:{
        "Content-Type":"application/json",
        Authorization:"Bearer "+token
      },
      body:JSON.stringify({
        raceId:+new URLSearchParams(location.search).get("id"),
        chevaux:selectedHorses,
        type:betType.value,
        montant:+stakeInput.value
      })
    }
  );

  location.reload();
}

</script>

</body>
</html>
