<script>

/* =================================================
   âœ… INIT DIRECT (PAS DOMContentLoaded !!!)
================================================= */

init();

async function init(){

  const token = localStorage.getItem("token");
  if(!token){
    window.location.href = "login.html";
    return;
  }

  const params = new URLSearchParams(window.location.search);
  const raceId = params.get("id");

  if(!raceId){
    window.location.href = "races.html";
    return;
  }

  await loadBalance(token);
  await loadRace(raceId);
}



/* =================================================
   ðŸ”¹ SOLDE UTILISATEUR (API SAFE)
================================================= */

async function loadBalance(token){

  try{

    const res = await fetch(
      "https://sulky-manager-backend.onrender.com/api/users/me",
      {
        headers:{ Authorization:"Bearer "+token }
      }
    );

    const user = await res.json();

    const box = document.getElementById("balanceBox");
    if(box) box.innerText = "ðŸ’° " + user.balance + " â‚¬";

    localStorage.setItem("balance", user.balance);

  }
  catch(err){
    console.error("Balance error:", err);
  }
}



/* =================================================
   ðŸ”¹ VARIABLES
================================================= */

let selectedHorses = [];



/* =================================================
   ðŸ”¹ LOAD COURSE
================================================= */

async function loadRace(raceId){

  const url =
    "https://sulky-manager-backend.onrender.com/api/races/" + raceId;

  try{

    const res = await fetch(url);

    if(!res.ok)
      throw new Error("API error");

    const race = await res.json();

    const title = document.getElementById("raceTitle");
    const date  = document.getElementById("raceDate");

    if(title) title.innerText = race.label;
    if(date)  date.innerText  = race.date || "";

    const tbody = document.querySelector("#partantsTable tbody");
    if(!tbody) return;

    tbody.innerHTML = "";

    race.partants.forEach((p, index) => {

      const tr = document.createElement("tr");

      tr.innerHTML = `
        <td>${index+1}</td>
        <td>${p.cheval}</td>
        <td>${p.driver}</td>
        <td>${p.proprietaire}</td>
        <td>${p.musique}</td>
        <td>${p.cote}</td>
        <td class="check-cell">â¬œ</td>
      `;

      tr.addEventListener("click", () => toggleHorse(p, tr));

      tbody.appendChild(tr);
    });

  }
  catch(err){
    console.error("Race load error:", err);
    alert("Erreur chargement course");
  }
}



/* =================================================
   ðŸ”¹ HELPERS
================================================= */

function requiredCount(type){
  switch(type){
    case "simple_win":
    case "simple_place": return 1;
    case "couple": return 2;
    case "trio": return 3;
    default: return 1;
  }
}



/* =================================================
   ðŸ”¹ SELECTION CHEVAUX
================================================= */

function toggleHorse(horse, row){

  const type = document.getElementById("betType").value;
  const max = requiredCount(type);

  const index = selectedHorses.findIndex(h => h.cheval === horse.cheval);
  const checkCell = row.querySelector(".check-cell");

  /* dÃ©cocher */
  if(index >= 0){
    selectedHorses.splice(index,1);
    row.classList.remove("selected-row");
    checkCell.innerText = "â¬œ";
  }

  /* cocher */
  else{

    if(selectedHorses.length >= max){
      alert(`Maximum ${max} cheval(x)`);
      return;
    }

    selectedHorses.push(horse);
    row.classList.add("selected-row");
    checkCell.innerText = "âœ…";
  }

  updateSlip();
}



function updateSlip(){

  const box = document.getElementById("selectedList");

  if(!box) return;

  if(!selectedHorses.length){
    box.innerText = "Aucun cheval sÃ©lectionnÃ©";
    return;
  }

  box.innerHTML = selectedHorses
    .map(h => `â€¢ ${h.cheval} (${h.cote})`)
    .join("<br>");
}



/* =================================================
   ðŸ”¹ CONFIRMER PARI
================================================= */

async function confirmBet(){

  const token = localStorage.getItem("token");

  const stake = Number(document.getElementById("stakeInput").value);
  const type = document.getElementById("betType").value;

  const params = new URLSearchParams(window.location.search);
  const raceId = params.get("id");

  const needed = requiredCount(type);

  if(selectedHorses.length !== needed){
    alert(`Ce pari nÃ©cessite ${needed} cheval(x)`);
    return;
  }

  if(!stake || stake <= 0){
    alert("Mise invalide");
    return;
  }

  try{

    const res = await fetch(
      "https://sulky-manager-backend.onrender.com/api/bets",
      {
        method:"POST",
        headers:{
          "Content-Type":"application/json",
          "Authorization":"Bearer "+token
        },
        body: JSON.stringify({
          raceId:Number(raceId),
          chevaux:selectedHorses,
          type,
          montant:stake
        })
      }
    );

    const data = await res.json();

    alert("âœ… Pari enregistrÃ© !");
    localStorage.setItem("balance", data.balance);

    location.reload();

  }
  catch(err){
    console.error(err);
    alert("Erreur pari");
  }
}

</script>
