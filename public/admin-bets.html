<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Sulky-Bet â€“ Admin Paris</title>
<link rel="stylesheet" href="style.css">

<style>

body{
  background:
    linear-gradient(rgba(0,0,0,.6), rgba(0,0,0,.85)),
    url("images/bg.jpg");
  background-size:cover;
  color:white;
  font-family:Segoe UI;
}

/* ===== WRAPPER ===== */

.wrapper{
  max-width:1400px;
  margin:60px auto;
  padding:25px;
}

/* ===== STATS CARDS ===== */

.stats{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
  gap:20px;
  margin-bottom:25px;
}

.card{
  background:rgba(0,0,0,.55);
  padding:20px;
  border-radius:14px;
  text-align:center;
  border:1px solid #00ff88;
}

.card h3{
  color:#00ff88;
  margin-bottom:8px;
}

/* ===== FILTERS ===== */

.filters{
  display:flex;
  gap:15px;
  margin-bottom:15px;
}

.filters input{
  padding:8px;
  border-radius:8px;
  border:none;
}

/* ===== TABLE ===== */

table{
  width:100%;
  border-collapse:collapse;
}

th{
  background:#000;
  color:#00ff88;
  padding:10px;
}

td{
  padding:8px;
  background:rgba(0,0,0,.55);
  text-align:center;
}

.status-win{ color:#00ff88; }
.status-lose{ color:#ff5555; }
.status-pending{ color:#ffaa00; }

button{
  margin-top:15px;
}

</style>
</head>


<body>

<div class="wrapper">

<h2 style="color:#00ff88;">ðŸ“Š Gestion globale des paris</h2>

<!-- ================= STATS ================= -->

<div class="stats">
  <div class="card">
    <h3>Total mises</h3>
    <div id="totalStake">0â‚¬</div>
  </div>

  <div class="card">
    <h3>Total gains</h3>
    <div id="totalGain">0â‚¬</div>
  </div>

  <div class="card">
    <h3>Nombre paris</h3>
    <div id="totalBets">0</div>
  </div>
</div>


<!-- ================= FILTERS ================= -->

<div class="filters">
  <input id="filterUser" placeholder="Filtrer joueur">
  <input id="filterRace" placeholder="Filtrer course">
  <button onclick="exportCSV()">ðŸ“¤ Export CSV</button>
</div>


<!-- ================= TABLE ================= -->

<table id="betsTable">
<thead>
<tr>
  <th>Joueur</th>
  <th>Course</th>
  <th>Chevaux</th>
  <th>Type</th>
  <th>Mise</th>
  <th>Gain</th>
  <th>Statut</th>
  <th>Date</th>
</tr>
</thead>
<tbody></tbody>
</table>

<button onclick="location.href='dashboard.html'">â¬… Retour</button>

</div>


<script>

const token = localStorage.getItem("token");
if(!token) location.href="login.html";

let ALL_BETS = [];

loadBets();


/* ================= LOAD ================= */

async function loadBets(){

  const res = await fetch(
    "https://sulky-manager-backend.onrender.com/api/admin/bets",
    { headers:{ Authorization:"Bearer "+token }}
  );

  ALL_BETS = await res.json();

  render(ALL_BETS);
  updateStats(ALL_BETS);
}


/* ================= RENDER TABLE ================= */

function render(bets){

  const tbody = document.querySelector("#betsTable tbody");
  tbody.innerHTML="";

  bets.forEach(b=>{

    const tr = document.createElement("tr");

    const horses = (b.chevaux||[]).map(h=>h.cheval).join(", ");

    tr.innerHTML=`
      <td>${b.userPseudo}</td>
      <td>${b.raceLabel || "-"}</td>
      <td>${horses}</td>
      <td>${b.type}</td>
      <td>${b.montant}â‚¬</td>
      <td>${b.gain}â‚¬</td>
      <td class="status-${b.status}">${b.status}</td>
      <td>${new Date(b.createdAt).toLocaleString()}</td>
    `;

    tbody.appendChild(tr);
  });
}


/* ================= STATS ================= */

function updateStats(bets){

  const stake = bets.reduce((a,b)=>a+b.montant,0);
  const gain  = bets.reduce((a,b)=>a+b.gain,0);

  totalStake.innerText = stake+"â‚¬";
  totalGain.innerText  = gain+"â‚¬";
  totalBets.innerText  = bets.length;
}


/* ================= FILTERS ================= */

filterUser.oninput = filter;
filterRace.oninput = filter;

function filter(){

  const u = filterUser.value.toLowerCase();
  const r = filterRace.value.toLowerCase();

  const filtered = ALL_BETS.filter(b=>
    b.userPseudo.toLowerCase().includes(u) &&
    (b.raceLabel||"").toLowerCase().includes(r)
  );

  render(filtered);
  updateStats(filtered);
}


/* ================= CSV EXPORT ================= */

function exportCSV(){

  let csv="Joueur,Course,Chevaux,Type,Mise,Gain,Statut,Date\n";

  ALL_BETS.forEach(b=>{
    csv += `${b.userPseudo},${b.raceLabel},"${b.chevaux.map(h=>h.cheval).join(" ")}",${b.type},${b.montant},${b.gain},${b.status},${b.createdAt}\n`;
  });

  const blob = new Blob([csv], {type:"text/csv"});
  const url = URL.createObjectURL(blob);

  const a=document.createElement("a");
  a.href=url;
  a.download="bets.csv";
  a.click();
}

</script>

</body>
</html>
